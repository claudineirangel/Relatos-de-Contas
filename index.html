import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Plus, Trash2, Edit2, TrendingUp, TrendingDown, Search, Filter, CheckCircle, 
  Wallet, PieChart as PieChartIcon, Download, Upload, ChevronDown, Check, 
  Printer, AlertCircle, Clock, X, ArrowUp, ArrowDown, ArrowLeft, ListPlus, 
  MinusCircle, List, CreditCard, Tag, ArrowRightLeft, Repeat, BarChart3, 
  Landmark, CalendarDays
} from 'lucide-react';

// ====================================================================================
// 1. DATA CONSTANTS
// ====================================================================================

const DEFAULT_INCOME_CATEGORIES = {
    "Salário": ["Adiantamento", "Férias", "Salário", "13º Salário"],
    "Investimentos": ["Dividendos", "Juros", "Renda Fixa", "FIIs"],
    "Transferência": ["Entrada"], 
    "Outras": ["Presente", "Bônus", "Reembolso", "Venda de Bens", "Freelance"]
};

const DEFAULT_EXPENSE_CATEGORIES = {
    "Alimentação": ["Feira", "Supermercado", "Lanches", "Restaurante", "Delivery", "Padaria"],
    "Moradia": ["Aluguel", "Condomínio", "Prestação", "Contas Fixas", "Manutenção", "Materiais", "Serviços", "Móveis", "Decoração"],
    "Transporte": ["Combustível", "Pedágio", "Manutenção", "Seguro", "IPVA", "Uber/Táxi", "Passagem", "Estacionamento"],
    "Veículo": ["Serviço", "Seguro", "IPVA", "Licenciamento"],
    "Pensão": ["Alimentícia"],
    "Filho": ["Lucas", "Lara", "Lorenzo", "Mariah"],
    "Mara": ["Academia", "Vestuário", "Diversão", "Viagem", "Lazer", "Presente", "Saúde", "Alimentação", "Transporte", "Utilidade"],
    "Lazer": ["Streaming", "Cinema/Teatro", "Show/Festa", "Passeio", "Bar", "Hobby", "Viagem"],
    "Saúde": ["Plano de Saúde", "Médico", "Dentista", "Exames", "Psicólogo", "Farmácia", "Ótica"],
    "Educação": ["Mensalidade", "Material", "Curso", "Livros"],
    "Sazonal": ["Imprevistos"],
    "Vestuário": ["Roupas", "Calçados", "Acessórios"],
    "Cuidados Pessoais": ["Salão de Beleza", "Barbeiro", "Cosméticos", "Academia"],
    "Cartão de Crédito": ["Fatura"],
    "Transferência": ["Saída"],
    "Financeiro": ["Tarifas", "Empréstimos", "Juros", "Câmbio", "Tributos", "Investimentos", "Seguros"],
    "Doações/Presentes": ["Doação", "Presente"],
    "Pessoal": ["Saque", "Adiantamento"],
    "Serviços": ["Streaming", "Software", "Honorários", "Assinaturas", "Internet", "Celular"]
};

const DEFAULT_ACCOUNTS = {
    'Conta Corrente': ["Banestes", "Recargaplay", "Neon", "Digio", "Mercado Livre"],
    'Conta Poupança': ["Banestes", "Bradesco", "Banco do Brasil"],
    'Conta de Pagamento': ["Nubank", "PicPay", "Mercado Pago", "Despesas"],
    'Cartão de Crédito': ["Recargaplay", "Mastercard", "American Express", "Nubank Card", "Inter Black", "Neon", "Banco Pan", "Digio", "Mercado Livre"],
    'Conta Despesa': ["Caixinha", "Cofre"],
    'Dinheiro': ["Carteira"],
    'Outros': ['Outros']
};

const CHART_COLORS = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#84cc16'];

// ====================================================================================
// UTILS
// ====================================================================================

const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
const formatCurrencyShort = (value) => {
    if (!value) return '';
    if (value >= 1000) return (value / 1000).toFixed(1) + 'k';
    return Math.round(value).toString();
};
const formatDate = (dateString) => {
    if (!dateString) return '-';
    const [year, month, day] = dateString.split('-');
    return `${day}/${month}/${year}`;
};
const formatShortDate = (dateString) => {
    if (!dateString) return '';
    const [year, month, day] = dateString.split('-');
    return `${day}/${month}`;
};
const getMonthYearLabel = (dateString) => {
    if (!dateString) return '';
    const date = new Date(dateString + 'T12:00:00');
    return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
};
const getAccountType = (accountName) => {
    for (const [type, accounts] of Object.entries(DEFAULT_ACCOUNTS)) {
        if (accounts.includes(accountName)) return type;
    }
    return 'Outros';
};
const getAllAccountsFlat = () => Object.entries(DEFAULT_ACCOUNTS).flatMap(([type, accounts]) => accounts.map(acc => ({ type, name: acc })));

const getStatusInfo = (t) => {
    if (t.status === 'paid') return { label: 'Pago', colorClass: 'bg-green-50 text-green-700 border-green-200', icon: <CheckCircle size={12} /> };
    const today = new Date(); today.setHours(0, 0, 0, 0);
    if (!t.dueDate) return { label: 'Pendente', colorClass: 'bg-gray-100', icon: <Clock size={12} /> };
    const [y, m, d] = t.dueDate.split('-').map(Number);
    const dueDate = new Date(y, m - 1, d);
    const diffDays = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
    if (diffDays < 0) return { label: `Vencido há ${Math.abs(diffDays)} dias`, colorClass: 'bg-red-50 text-red-700 border-red-200', icon: <AlertCircle size={12} /> };
    if (diffDays === 0) return { label: 'Vence hoje', colorClass: 'bg-orange-50 text-orange-700 border-orange-200', icon: <div className="w-2 h-2 rounded-full bg-orange-500" /> };
    return { label: `Vence em ${diffDays} dias`, colorClass: 'bg-blue-50 text-blue-700 border-blue-200', icon: <Clock size={12} /> };
};

// ====================================================================================
// DATA LAYER (LocalStorage)
// ====================================================================================

const DataService = {
  getTransactions: () => {
    try { return JSON.parse(localStorage.getItem('transactions') || '[]').sort((a, b) => new Date(b.dueDate).getTime() - new Date(a.dueDate).getTime()); } 
    catch (e) { return []; }
  },
  addTransaction: (transaction) => {
    const transactions = DataService.getTransactions();
    let nextId = parseInt(localStorage.getItem('nextTransactionId') || '1', 10);
    const repeatCount = (transaction.isRecurring && transaction.repeatMonths > 0) ? transaction.repeatMonths : 1;
    const frequency = transaction.frequency || 'monthly';
    
    for (let i = 0; i < repeatCount; i++) {
        const date = new Date(transaction.dueDate + 'T12:00:00');
        if (i > 0) {
            if (frequency === 'quinzenal') date.setDate(date.getDate() + (i * 15));
            else if (frequency === 'trimestral') date.setMonth(date.getMonth() + (i * 3));
            else if (frequency === 'semestral') date.setMonth(date.getMonth() + (i * 6));
            else if (frequency === 'anual') date.setFullYear(date.getFullYear() + i);
            else date.setMonth(date.getMonth() + i);
        }
        transactions.push({ ...transaction, id: 'txn_' + nextId, dueDate: date.toISOString().split('T')[0], status: i === 0 ? transaction.status : 'pending', paymentDate: i === 0 ? transaction.paymentDate : '', paymentBank: i === 0 ? transaction.paymentBank : '' });
        nextId++;
    }
    localStorage.setItem('transactions', JSON.stringify(transactions));
    localStorage.setItem('nextTransactionId', String(nextId));
  },
  addManyTransactions: (newTs) => {
    const ts = DataService.getTransactions();
    let nextId = parseInt(localStorage.getItem('nextTransactionId') || '1', 10);
    const toAdd = newTs.map(t => ({ ...t, id: 'txn_' + nextId++ }));
    localStorage.setItem('transactions', JSON.stringify([...ts, ...toAdd]));
    localStorage.setItem('nextTransactionId', String(nextId));
    return toAdd.length;
  },
  updateTransaction: (id, updates) => {
    const ts = DataService.getTransactions();
    const index = ts.findIndex(t => t.id === id);
    if (index !== -1) { ts[index] = { ...ts[index], ...updates }; localStorage.setItem('transactions', JSON.stringify(ts)); }
  },
  deleteTransaction: (id) => {
    const ts = DataService.getTransactions().filter(t => t.id !== id);
    localStorage.setItem('transactions', JSON.stringify(ts));
  }
};

const parseCSV = async (file) => {
    const text = await file.text();
    const lines = text.split('\n').filter(l => l.trim());
    if (lines.length < 2) return { error: 'Arquivo vazio' };
    return { data: lines.slice(1).map(l => {
        const c = l.split(',').map(x => x.replace(/^"|"$/g, '').trim());
        if (c.length < 5) return null;
        return { description: c[0], amount: parseFloat(c[1]), type: c[2], dueDate: c[3], account: c[4] || 'Outros', accountType: c[5] || 'Outros', costCenter: c[6], category: c[7], subcategory: c[8], status: c[9], paymentDate: c[10], paymentBank: c[11], isRecurring: false, repeatMonths: 0, items: [] };
    }).filter(Boolean) };
};

const exportTransactionsToCSV = (ts) => {
    const csv = ['description,amount,type,dueDate,account,accountType,costCenter,category,subcategory,status,paymentDate,paymentBank', ...ts.map(t => [t.description, t.amount, t.type, t.dueDate, t.account, t.accountType, t.costCenter, t.category, t.subcategory, t.status, t.paymentDate, t.paymentBank].map(x => `"${x || ''}"`).join(','))].join('\n');
    const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = 'transacoes.csv'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
};

// ====================================================================================
// COMPONENTS
// ====================================================================================

const Modal = ({ children, onClose }) => (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
        <div className="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
             {children}
        </div>
    </div>
);

const ReportsView = ({ transactions }) => {
    const [selectedMonth, setSelectedMonth] = useState('all');
    const months = useMemo(() => Array.from(new Set(transactions.map(t => t.dueDate.slice(0, 7)))).sort().reverse(), [transactions]);

    const monthlyData = useMemo(() => {
        const data = {};
        months.sort().forEach(m => data[m] = { income: 0, expense: 0, label: new Date(m + '-01T12:00:00').toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }) });
        transactions.forEach(t => { if (data[t.dueDate.slice(0, 7)]) t.type === 'income' ? data[t.dueDate.slice(0, 7)].income += t.amount : data[t.dueDate.slice(0, 7)].expense += t.amount; });
        return Object.values(data);
    }, [transactions, months]);

    const accountsData = useMemo(() => {
        const accs = {};
        transactions.filter(t => selectedMonth === 'all' || t.dueDate.startsWith(selectedMonth)).forEach(t => {
            const name = (t.status === 'paid' && t.paymentBank) ? t.paymentBank : (t.account || 'Outros');
            const type = (t.status === 'paid' && t.paymentBank) ? getAccountType(name) : (t.accountType || 'Outros');
            if (!accs[type]) accs[type] = {};
            accs[type][name] = (accs[type][name] || 0) + (t.type === 'income' ? t.amount : -t.amount);
        });
        return accs;
    }, [transactions, selectedMonth]);

    const categoryData = useMemo(() => {
        const groups = {};
        let total = 0;
        transactions.filter(t => t.type === 'expense' && (selectedMonth === 'all' || t.dueDate.startsWith(selectedMonth))).forEach(t => {
            const g = t.costCenter || 'Outros', c = t.category || 'Geral';
            if (!groups[g]) groups[g] = { value: 0, cats: {} };
            groups[g].value += t.amount; groups[g].cats[c] = (groups[g].cats[c] || 0) + t.amount;
            total += t.amount;
        });
        return Object.entries(groups).map(([name, d]) => ({ name, value: d.value, percent: total ? (d.value/total)*100 : 0, cats: Object.entries(d.cats).map(([n, v]) => ({ name: n, value: v })).sort((a,b) => b.value - a.value) })).sort((a,b) => b.value - a.value).map((x, i) => ({ ...x, color: CHART_COLORS[i % CHART_COLORS.length] }));
    }, [transactions, selectedMonth]);

    const pieGradient = useMemo(() => {
        let cum = 0;
        const p = categoryData.map(d => `${d.color} ${cum}% ${(cum += d.percent)}%`);
        return p.length ? `conic-gradient(${p.join(', ')})` : 'gray 0% 100%';
    }, [categoryData]);

    const maxVal = Math.max(...monthlyData.map(d => Math.max(d.income, d.expense)), 1) * 1.1;

    return (
        <div className="space-y-6">
            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col sm:flex-row justify-between items-center gap-4">
                <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><BarChart3 className="text-indigo-600" /> Relatórios</h3>
                <div className="relative w-full sm:w-64">
                    <CalendarDays className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" size={18} />
                    <select value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="w-full pl-10 pr-8 py-2.5 border border-gray-300 rounded-lg text-sm appearance-none bg-white">
                        <option value="all">Todos os Meses</option>
                        {months.map(m => <option key={m} value={m}>{getMonthYearLabel(m)}</option>)}
                    </select>
                    <ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none" size={16} />
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {Object.entries(accountsData).map(([type, accs]) => (
                    Object.values(accs).some(v => v !== 0) && (
                        <div key={type} className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2"><Landmark size={14} /> {type}</h4>
                            <div className="space-y-2">
                                {Object.entries(accs).filter(([_, v]) => v !== 0).map(([n, v]) => (
                                    <div key={n} className="flex justify-between text-sm border-b border-gray-50 pb-1">
                                        <span className="text-gray-700">{n}</span>
                                        <span className={`font-bold ${v >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(v)}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )
                ))}
            </div>

            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm overflow-x-auto">
                <h3 className="text-lg font-bold text-gray-800 mb-6 flex gap-2"><TrendingUp className="text-blue-500" /> Evolução Mensal</h3>
                <div className="h-64 flex items-end gap-4 min-w-[600px] pt-6 relative">
                    <div className="absolute inset-0 flex flex-col justify-between text-xs text-gray-300 pointer-events-none pt-6 pb-6">
                        {[...Array(5)].map((_, i) => <div key={i} className="border-b border-gray-100 w-full h-0 relative"><span className="absolute -top-3 bg-white pr-1">{i===4?'0':''}</span></div>)}
                    </div>
                    {monthlyData.map((d, i) => (
                        <div key={i} className="flex-1 flex flex-col justify-end gap-1 h-full z-10">
                            <div className="w-full flex gap-1 items-end justify-center h-full">
                                <div className="w-full max-w-[30px] flex flex-col items-center justify-end h-full">
                                    {d.income > 0 && <span className="text-[10px] text-green-600 font-bold mb-1 -rotate-45 origin-bottom-left">{formatCurrencyShort(d.income)}</span>}
                                    <div className="w-full bg-green-400 rounded-t-sm opacity-90 hover:bg-green-500 transition-all" style={{ height: `${(d.income/maxVal)*100}%`, minHeight: d.income>0?'4px':'0' }}></div>
                                </div>
                                <div className="w-full max-w-[30px] flex flex-col items-center justify-end h-full">
                                    {d.expense > 0 && <span className="text-[10px] text-red-600 font-bold mb-1 -rotate-45 origin-bottom-left">{formatCurrencyShort(d.expense)}</span>}
                                    <div className="w-full bg-red-400 rounded-t-sm opacity-90 hover:bg-red-500 transition-all" style={{ height: `${(d.expense/maxVal)*100}%`, minHeight: d.expense>0?'4px':'0' }}></div>
                                </div>
                            </div>
                            <span className="text-[10px] text-gray-500 text-center uppercase font-bold truncate w-full mt-1">{d.label}</span>
                        </div>
                    ))}
                </div>
            </div>

            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row gap-8">
                <div className="flex-shrink-0 relative mx-auto md:mx-0 sticky top-4">
                    <div className="w-48 h-48 rounded-full border-4 border-white shadow-lg" style={{ background: pieGradient }}></div>
                    <div className="absolute inset-0 m-auto w-24 h-24 bg-white rounded-full flex items-center justify-center font-bold text-gray-400 text-xs shadow-inner">TOTAL</div>
                </div>
                <div className="flex-1 space-y-4">
                    {categoryData.map((g, i) => (
                        <div key={i} className="bg-gray-50 rounded-xl p-3 border border-gray-100">
                            <div className="flex justify-between text-sm mb-2">
                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{backgroundColor: g.color}}></div><span className="font-bold text-gray-800">{g.name}</span></div>
                                <span className="font-bold text-gray-900">{formatCurrency(g.value)} <span className="text-gray-400 text-xs">({g.percent.toFixed(1)}%)</span></span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden mb-3"><div className="h-1.5 rounded-full" style={{width: `${g.percent}%`, backgroundColor: g.color}}></div></div>
                            <div className="pl-5 grid grid-cols-1 sm:grid-cols-2 gap-2">
                                {g.cats.map((c, idx) => (
                                    <div key={idx} className="flex justify-between text-xs text-gray-600 bg-white p-2 rounded border border-gray-200 shadow-sm">
                                        <span className="truncate mr-2">{c.name}</span><span className="font-bold">{formatCurrency(c.value)}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

const TransactionForm = ({ initialData, onSave, onCancel }) => {
    const [data, setData] = useState({ description: '', amount: '', type: 'expense', dueDate: new Date().toISOString().split('T')[0], purchaseDate: '', paymentDate: '', accountType: '', account: '', costCenter: '', category: '', subcategory: '', status: 'pending', isRecurring: false, repeatMonths: 0, frequency: 'monthly', paymentBank: '', items: [] });
    const [newItem, setNewItem] = useState({ description: '', amount: '', category: '', date: new Date().toISOString().split('T')[0] });

    useEffect(() => { if (initialData) setData({ ...initialData, amount: String(initialData.amount), repeatMonths: initialData.repeatMonths || 0, items: initialData.items || [] }); }, [initialData]);

    const handleSubmit = (e) => { e.preventDefault(); onSave({ ...data, amount: parseFloat(data.amount) || 0, repeatMonths: parseInt(data.repeatMonths || 0), paymentDate: data.status === 'paid' && !data.paymentDate ? new Date().toISOString().split('T')[0] : data.paymentDate }); };
    const addItem = () => { if (!newItem.description || !newItem.amount) return; setData(p => ({ ...p, items: [...p.items, { ...newItem, id: Date.now() }] })); setNewItem(p => ({ ...p, description: '', amount: '' })); };
    
    const itemsTotal = data.items.reduce((acc, i) => acc + (parseFloat(i.amount) || 0), 0);
    const diff = (parseFloat(data.amount) || 0) - itemsTotal;

    return (
        <Modal onClose={onCancel}>
            <div className="px-6 py-4 border-b bg-gray-50 flex justify-between"><h2 className="text-lg font-bold">{initialData ? 'Editar' : 'Nova Transação'}</h2><button onClick={onCancel}><X /></button></div>
            <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto p-6 space-y-6">
                <div className="flex bg-gray-100 p-1 rounded-xl">
                    {['income', 'expense'].map(t => (
                        <button key={t} type="button" onClick={() => setData({ ...data, type: t })} className={`flex-1 py-2 rounded-lg font-bold text-sm ${data.type === t ? (t === 'income' ? 'bg-green-500 text-white' : 'bg-red-500 text-white') : 'text-gray-500'}`}>{t === 'income' ? 'Receita' : 'Despesa'}</button>
                    ))}
                </div>
                <div>
                    <label className="text-xs font-bold text-gray-500 uppercase">Valor Total</label>
                    <div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-xl">R$</span><input required type="number" step="0.01" className="w-full pl-12 pr-4 py-4 text-3xl font-bold border-2 rounded-xl focus:outline-none" value={data.amount} onChange={e => setData({ ...data, amount: e.target.value })} /></div>
                    {data.items.length > 0 && <div className="text-xs flex justify-between mt-2 px-1 text-gray-500"><span>Soma: {formatCurrency(itemsTotal)}</span><span className={diff !== 0 ? (diff < 0 ? 'text-red-500' : 'text-orange-500') : 'text-green-500'}>{diff === 0 ? 'Batido' : `Dif: ${formatCurrency(Math.abs(diff))}`}</span></div>}
                </div>
                <input required placeholder="Descrição" className="w-full px-4 py-2 border rounded-xl" value={data.description} onChange={e => setData({ ...data, description: e.target.value })} />
                <div className="grid grid-cols-2 gap-4">
                    <div><label className="text-xs">Vencimento</label><input required type="date" className="w-full px-4 py-2 border rounded-xl" value={data.dueDate} onChange={e => setData({ ...data, dueDate: e.target.value })} /></div>
                    <div onClick={() => setData({ ...data, status: data.status === 'paid' ? 'pending' : 'paid' })} className={`cursor-pointer px-4 py-2 border rounded-xl flex items-center justify-center gap-2 mt-4 font-bold ${data.status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>{data.status === 'paid' ? <CheckCircle size={18} /> : <div className="w-4 h-4 rounded-full border-2 border-gray-400" />} {data.status === 'paid' ? 'Pago' : 'Pendente'}</div>
                </div>
                {data.status === 'paid' && <div className="grid grid-cols-2 gap-4 animate-in fade-in">
                    <div><label className="text-xs">Data Pagamento</label><input type="date" className="w-full px-4 py-2 border rounded-xl" value={data.paymentDate} onChange={e => setData({ ...data, paymentDate: e.target.value })} /></div>
                    <div><label className="text-xs">Banco Pagador</label><select className="w-full px-4 py-2 border rounded-xl" value={data.paymentBank} onChange={e => setData({ ...data, paymentBank: e.target.value })}><option value="">Selecione...</option>{getAllAccountsFlat().map(a => <option key={a.name} value={a.name}>{a.name}</option>)}</select></div>
                </div>}
                <div className="space-y-4 border-t pt-4">
                    <div className="grid grid-cols-2 gap-4">
                        <select required className="w-full px-4 py-2 border rounded-xl" value={data.costCenter} onChange={e => setData({ ...data, costCenter: e.target.value })}><option value="">Grupo...</option>{Object.keys(data.type === 'income' ? DEFAULT_INCOME_CATEGORIES : DEFAULT_EXPENSE_CATEGORIES).map(k => <option key={k} value={k}>{k}</option>)}</select>
                        <select required className="w-full px-4 py-2 border rounded-xl" value={data.category} onChange={e => setData({ ...data, category: e.target.value })} disabled={!data.costCenter}><option value="">Categoria...</option>{(data.type === 'income' ? DEFAULT_INCOME_CATEGORIES : DEFAULT_EXPENSE_CATEGORIES)[data.costCenter]?.map(c => <option key={c} value={c}>{c}</option>)}</select>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <select required className="w-full px-4 py-2 border rounded-xl" value={data.accountType} onChange={e => setData({ ...data, accountType: e.target.value })}><option value="">Tipo Conta...</option>{Object.keys(DEFAULT_ACCOUNTS).map(k => <option key={k} value={k}>{k}</option>)}</select>
                        <select required className="w-full px-4 py-2 border rounded-xl" value={data.account} onChange={e => setData({ ...data, account: e.target.value })} disabled={!data.accountType}><option value="">Qual a conta...</option>{DEFAULT_ACCOUNTS[data.accountType]?.map(a => <option key={a} value={a}>{a}</option>)}</select>
                    </div>
                </div>
                <div className="bg-gray-50 p-4 rounded-xl border">
                    <h3 className="text-xs font-bold text-gray-500 uppercase mb-3 flex gap-2"><ListPlus size={14}/> Itens / Detalhes</h3>
                    <div className="flex gap-2 mb-2">
                        <input type="date" className="w-24 px-2 py-1 border rounded text-xs" value={newItem.date} onChange={e => setNewItem({ ...newItem, date: e.target.value })} />
                        <input placeholder="Item" className="flex-1 px-2 py-1 border rounded text-xs" value={newItem.description} onChange={e => setNewItem({ ...newItem, description: e.target.value })} />
                        <select className="w-24 px-2 py-1 border rounded text-xs" value={newItem.category} onChange={e => setNewItem({ ...newItem, category: e.target.value })}><option value="">Cat...</option>{Object.keys(DEFAULT_EXPENSE_CATEGORIES).map(c => <option key={c} value={c}>{c}</option>)}</select>
                        <input type="number" placeholder="$$" className="w-16 px-2 py-1 border rounded text-xs" value={newItem.amount} onChange={e => setNewItem({ ...newItem, amount: e.target.value })} />
                        <button type="button" onClick={addItem} className="bg-blue-600 text-white p-1 rounded"><Plus size={16} /></button>
                    </div>
                    <div className="max-h-32 overflow-y-auto space-y-1">{data.items.map(i => (
                        <div key={i.id} className="flex justify-between items-center text-xs bg-white p-2 rounded border"><span className="flex-1">{i.description} <span className="text-gray-400">({i.category})</span></span><span className="font-bold">{formatCurrency(i.amount)}</span><button type="button" onClick={() => setData(p => ({ ...p, items: p.items.filter(x => x.id !== i.id) }))} className="text-red-400 ml-2"><MinusCircle size={14} /></button></div>
                    ))}</div>
                </div>
                <div className="border-t pt-4"><label className="flex items-center gap-3"><input type="checkbox" checked={data.isRecurring} onChange={e => setData({ ...data, isRecurring: e.target.checked })} /><span className="text-sm font-medium">Repetir</span></label>{data.isRecurring && <div className="mt-2 grid grid-cols-2 gap-3"><select className="border p-2 rounded" value={data.frequency} onChange={e => setData({ ...data, frequency: e.target.value })}><option value="mensal">Mensal</option><option value="quinzenal">Quinzenal</option><option value="trimestral">Trimestral</option><option value="semestral">Semestral</option><option value="anual">Anual</option></select><input type="number" className="border p-2 rounded" placeholder="Vezes" value={data.repeatMonths} onChange={e => setData({ ...data, repeatMonths: e.target.value })} /></div>}</div>
            </form>
            <div className="p-4 border-t flex justify-end gap-3"><button onClick={onCancel} className="px-6 py-2 rounded-lg text-gray-600 hover:bg-gray-100">Cancelar</button><button onClick={handleSubmit} className="px-8 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button></div>
        </Modal>
    );
};

// ====================================================================================
// DETAILS MODAL
// ====================================================================================

const DetailModal = ({ transaction, onClose, onUpdate }) => {
    const [newItem, setNewItem] = useState({ description: '', amount: '', category: '', date: new Date().toISOString().split('T')[0] });
    if (!transaction) return null;
    const items = transaction.items || [];
    const itemsTotal = items.reduce((acc, i) => acc + (parseFloat(i.amount) || 0), 0);
    const diff = (parseFloat(transaction.amount) || 0) - itemsTotal;
    const handleAddItem = () => { if (!newItem.description || !newItem.amount) return; onUpdate(transaction.id, { items: [...items, { ...newItem, id: Date.now() }] }); setNewItem({ ...newItem, description: '', amount: '' }); };
    
    return (
        <Modal onClose={onClose}>
            <div className="px-6 py-4 border-b flex justify-between bg-gray-50"><h3 className="font-bold flex gap-2"><List className="text-purple-600"/> Detalhes</h3><button onClick={onClose}><X /></button></div>
            <div className="p-6 bg-gray-50/50 flex-1 overflow-y-auto">
                <div className="bg-white p-4 rounded-xl border mb-6">
                    <div className="flex justify-between mb-2"><span className="text-sm text-gray-500">Valor Fatura</span><span className="font-bold text-lg">{formatCurrency(transaction.amount)}</span></div>
                    <div className="flex justify-between mb-2"><span className="text-sm text-gray-500">Itens</span><span className="font-bold text-blue-600">{formatCurrency(itemsTotal)}</span></div>
                    <div className="border-t pt-2 flex justify-between"><span className="text-xs font-bold text-gray-400">DIFERENÇA</span><span className={`text-sm font-bold ${diff === 0 ? 'text-green-600' : 'text-red-500'}`}>{diff === 0 ? 'Batido' : formatCurrency(Math.abs(diff))}</span></div>
                </div>
                <div className="bg-purple-50 p-3 rounded-xl border border-purple-100 mb-4">
                    <div className="flex gap-2 mb-2"><input type="date" className="w-24 p-1 border rounded text-xs" value={newItem.date} onChange={e=>setNewItem({...newItem, date:e.target.value})} /><input className="flex-1 p-1 border rounded text-xs" placeholder="Item" value={newItem.description} onChange={e=>setNewItem({...newItem, description:e.target.value})} /><input type="number" className="w-16 p-1 border rounded text-xs" placeholder="$$" value={newItem.amount} onChange={e=>setNewItem({...newItem, amount:e.target.value})} /></div>
                    <div className="flex justify-between gap-2"><select className="flex-1 p-1 border rounded text-xs bg-white" value={newItem.category} onChange={e=>setNewItem({...newItem, category:e.target.value})}><option value="">Categoria...</option>{Object.keys(DEFAULT_EXPENSE_CATEGORIES).map(c=><option key={c} value={c}>{c}</option>)}</select><button onClick={handleAddItem} className="bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold">Add</button></div>
                </div>
                <div className="space-y-2">
                    {items.map(i => (
                        <div key={i.id} className="flex justify-between items-center bg-white p-3 rounded border text-sm">
                            <div><div className="font-bold">{i.description}</div><div className="text-xs text-gray-400">{formatShortDate(i.date)} - {i.category}</div></div>
                            <div className="flex gap-3 items-center"><span className="font-bold">{formatCurrency(i.amount)}</span><button onClick={() => onUpdate(transaction.id, { items: items.filter(x => x.id !== i.id) })} className="text-red-400"><MinusCircle size={14}/></button></div>
                        </div>
                    ))}
                </div>
            </div>
            <div className="p-4 border-t bg-white flex justify-end"><button onClick={onClose} className="px-6 py-2 bg-gray-100 rounded font-medium">Concluir</button></div>
        </Modal>
    );
};

export default function App() {
    const [transactions, setTransactions] = useState([]);
    const [view, setView] = useState('list');
    const [editingId, setEditingId] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [dateFilter, setDateFilter] = useState('all');
    const [paymentModal, setPaymentModal] = useState(null);
    const [deleteId, setDeleteId] = useState(null);
    const [detailData, setDetailData] = useState(null);
    const [transferModal, setTransferModal] = useState(false);
    const [sortDirection, setSortDirection] = useState('asc'); // Sort direction state

    const fileRef = useRef(null);
    
    useEffect(() => { setTransactions(DataService.getTransactions()); }, []);
    
    const refresh = () => setTransactions(DataService.getTransactions());
    
    const filtered = useMemo(() => {
        let data = transactions.filter(t => {
            const matchesSearch = !searchTerm || t.description.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesDate = dateFilter === 'all' || t.dueDate.startsWith(dateFilter);
            
            let matchesStatus = true;
            if (statusFilter === 'overdue') {
                // Logic for overdue: pending AND due date < today
                const today = new Date().toISOString().split('T')[0];
                matchesStatus = t.status === 'pending' && t.dueDate < today;
            } else if (statusFilter !== 'all') {
                matchesStatus = t.status === statusFilter;
            }
            
            return matchesSearch && matchesDate && matchesStatus;
        });

        // Apply sorting
        data.sort((a, b) => {
            const dateA = new Date(a.dueDate).getTime();
            const dateB = new Date(b.dueDate).getTime();
            return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
        });

        return data;
    }, [transactions, searchTerm, dateFilter, statusFilter, sortDirection]);

    const months = useMemo(() => Array.from(new Set(transactions.map(t => t.dueDate.slice(0, 7)))).sort().reverse(), [transactions]);
    
    const summary = useMemo(() => {
        const active = dateFilter === 'all' ? transactions : transactions.filter(t => t.dueDate.startsWith(dateFilter));
        return {
            balance: transactions.filter(t => t.status === 'paid').reduce((acc, t) => acc + (t.type === 'income' ? t.amount : -t.amount), 0), 
            toPay: active.filter(t => t.type === 'expense' && t.status === 'pending').reduce((acc, t) => acc + t.amount, 0),
            toReceive: active.filter(t => t.type === 'income' && t.status === 'pending').reduce((acc, t) => acc + t.amount, 0)
        };
    }, [transactions, dateFilter]);

    const handleSave = (d) => { editingId ? DataService.updateTransaction(editingId, d) : DataService.addTransaction(d); refresh(); setEditingId(null); setView('list'); };
    const handlePay = (id, date, acc) => { DataService.updateTransaction(id, { status: 'paid', paymentDate: date, paymentBank: acc }); refresh(); setPaymentModal(null); };
    const handleDelete = () => { DataService.deleteTransaction(deleteId); refresh(); setDeleteId(null); };
    const handleDetailUpdate = (id, updates) => { DataService.updateTransaction(id, updates); refresh(); setDetailData(DataService.getTransactions().find(t => t.id === id)); };

    return (
        <div className="min-h-screen bg-slate-50 font-sans text-slate-900 pb-10">
            <input type="file" ref={fileRef} className="hidden" onChange={async (e) => { const res = await parseCSV(e.target.files[0]); if(res.data) { DataService.addManyTransactions(res.data); refresh(); } }} />
            
            {deleteId && <Modal onClose={() => setDeleteId(null)}><div className="p-6 text-center"><h3 className="font-bold text-lg mb-2">Excluir?</h3><div className="flex gap-2 justify-center mt-4"><button onClick={() => setDeleteId(null)} className="px-4 py-2 border rounded">Não</button><button onClick={handleDelete} className="px-4 py-2 bg-red-600 text-white rounded">Sim</button></div></div></Modal>}
            
            {detailData && <DetailModal transaction={detailData} onClose={() => setDetailData(null)} onUpdate={handleDetailUpdate} />}

            {paymentModal && <Modal onClose={() => setPaymentModal(null)}>
                <div className="p-6 space-y-4">
                    <h3 className="font-bold text-lg">Confirmar Pagamento</h3>
                    <p className="text-sm bg-gray-50 p-2 rounded">Pagando: <strong>{paymentModal.description}</strong> ({formatCurrency(paymentModal.amount)})</p>
                    <div><label className="text-xs block">Data</label><input id="payDate" type="date" defaultValue={new Date().toISOString().split('T')[0]} className="border p-2 rounded w-full" /></div>
                    <div><label className="text-xs block">Conta</label><select id="payAcc" className="border p-2 rounded w-full"><option value="">Selecione...</option>{getAllAccountsFlat().map(a => <option key={a.name} value={a.name}>{a.name}</option>)}</select></div>
                    <button onClick={() => handlePay(paymentModal.id, document.getElementById('payDate').value, document.getElementById('payAcc').value)} className="w-full bg-green-600 text-white py-2 rounded font-bold">Confirmar</button>
                </div>
            </Modal>}

            {/* HEADER */}
            <header className="bg-white border-b sticky top-0 z-20 px-4 h-16 flex items-center justify-between print:hidden">
                <div className="flex items-center gap-2 font-bold text-xl text-slate-700"><Wallet className="text-blue-600"/> Fluxo Financeiro</div>
                <div className="flex gap-2">
                    {view === 'list' ? (
                        <>
                            <button onClick={() => fileRef.current.click()} className="p-2 hover:bg-gray-100 rounded" title="Importar"><Upload size={20}/></button>
                            <button onClick={() => exportTransactionsToCSV(transactions)} className="p-2 hover:bg-gray-100 rounded" title="Exportar"><Download size={20}/></button>
                            <button onClick={() => window.print()} className="p-2 hover:bg-gray-100 rounded" title="Imprimir"><Printer size={20}/></button>
                            <button onClick={() => setView('reports')} className="p-2 hover:bg-gray-100 rounded text-blue-600" title="Relatórios"><BarChart3 size={20}/></button>
                            <button onClick={() => setEditingId('new')} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex gap-2 items-center hover:bg-blue-700"><Plus size={18}/> Novo</button>
                        </>
                    ) : (
                        <button onClick={() => setView('list')} className="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded hover:bg-gray-200"><ArrowLeft size={18}/> Voltar</button>
                    )}
                </div>
            </header>

            <main className="max-w-7xl mx-auto p-4 sm:p-6 print:p-0">
                {view === 'reports' ? <ReportsView transactions={transactions} /> : (
                    <>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 print:mb-4">
                            {[{l:'Saldo Real', v: summary.balance, c:'bg-slate-800 text-white'}, {l:'A Pagar', v: summary.toPay, c:'bg-red-50 text-red-700 border-red-200 border'}, {l:'A Receber', v: summary.toReceive, c:'bg-green-50 text-green-700 border-green-200 border'}].map((x, i) => (
                                <div key={i} className={`p-5 rounded-xl shadow-sm ${x.c}`}><p className="text-sm opacity-80 font-medium">{x.l}</p><p className="text-2xl font-bold mt-1">{formatCurrency(x.v)}</p></div>
                            ))}
                        </div>

                        <div className="bg-white p-4 rounded-xl border shadow-sm mb-6 flex flex-col sm:flex-row gap-4 justify-between print:hidden">
                             <div className="relative flex-1"><Search className="absolute left-3 top-2.5 text-gray-400" size={18}/><input placeholder="Buscar..." className="w-full pl-10 pr-4 py-2 border rounded-lg" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                             <div className="flex gap-2">
                                <select className="border p-2 rounded-lg" value={dateFilter} onChange={e => setDateFilter(e.target.value)}><option value="all">Todos os Meses</option>{months.map(m => <option key={m} value={m}>{getMonthYearLabel(m)}</option>)}</select>
                                <div className="flex border rounded-lg overflow-hidden">
                                    <button onClick={() => setStatusFilter('all')} className={`px-3 py-2 ${statusFilter === 'all' ? 'bg-gray-100 font-bold' : ''}`}>Tudo</button>
                                    <button onClick={() => setStatusFilter('pending')} className={`px-3 py-2 ${statusFilter === 'pending' ? 'bg-yellow-50 text-yellow-700 font-bold' : ''}`}>Pendente</button>
                                    <button onClick={() => setStatusFilter('paid')} className={`px-3 py-2 ${statusFilter === 'paid' ? 'bg-green-50 text-green-700 font-bold' : ''}`}>Pago</button>
                                    <button onClick={() => setStatusFilter('overdue')} className={`px-3 py-2 ${statusFilter === 'overdue' ? 'bg-red-50 text-red-700 font-bold' : ''}`}>Vencido</button>
                                </div>
                             </div>
                        </div>

                        <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-gray-50 text-gray-500 border-b">
                                    <tr>
                                        <th className="p-4">Status</th>
                                        <th className="p-4">Descrição</th>
                                        <th className="p-4">Categoria</th>
                                        <th 
                                            className="p-4 cursor-pointer hover:bg-gray-100 transition-colors" 
                                            onClick={() => setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc')}
                                        >
                                            <div className="flex items-center gap-1">
                                                Vencimento
                                                {sortDirection === 'asc' ? <ArrowUp size={14}/> : <ArrowDown size={14}/>}
                                            </div>
                                        </th>
                                        <th className="p-4 text-right">Valor</th>
                                        <th className="p-4 text-center print:hidden">Ações</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filtered.map(t => {
                                        const s = getStatusInfo(t);
                                        return (
                                            <tr key={t.id} className="hover:bg-gray-50 group">
                                                <td className="p-4"><span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full border text-xs font-medium ${s.colorClass}`}>{s.icon} {s.label}</span></td>
                                                <td className="p-4 font-medium text-gray-900"><div>{t.description}</div><div className="text-xs text-gray-400 font-normal">{t.account}</div>{t.items && t.items.length > 0 && <div className="text-[10px] text-blue-600 mt-1 flex items-center gap-1"><ListPlus size={10} /> {t.items.length} itens</div>}</td>
                                                <td className="p-4 text-gray-600">{t.category}</td>
                                                <td className="p-4 text-gray-600">{formatDate(t.dueDate)}</td>
                                                <td className={`p-4 text-right font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>{t.type === 'expense' ? '- ' : '+ '} {formatCurrency(t.amount)}</td>
                                                <td className="p-4 text-center print:hidden flex justify-center gap-2">
                                                    {t.status === 'pending' && <button onClick={() => setPaymentModal(t)} className="p-1 text-green-600 hover:bg-green-100 rounded"><Check size={16}/></button>}
                                                    <button onClick={() => setEditingId(t.id)} className="p-1 text-blue-600 hover:bg-blue-100 rounded"><Edit2 size={16}/></button>
                                                    <button onClick={() => setDetailData(t)} className="p-1 text-purple-600 hover:bg-purple-100 rounded"><List size={16}/></button>
                                                    <button onClick={() => setDeleteId(t.id)} className="p-1 text-red-600 hover:bg-red-100 rounded"><Trash2 size={16}/></button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </>
                )}

                {editingId && <TransactionForm initialData={editingId !== 'new' ? transactions.find(t => t.id === editingId) : null} onSave={handleSave} onCancel={() => setEditingId(null)} />}
            </main>
        </div>
    );
}